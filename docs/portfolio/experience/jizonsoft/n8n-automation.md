# n8n 자동화 시스템 상세

## 시스템 개요

> 식자재 유통 업무의 **주문 접수 → 품목 매칭 → 발송 처리 → 고객 알림**까지 전 과정을 AI와 n8n 워크플로우로 자동화

### 도입 배경

**자동화 전 (AS-IS)**:
- 직원이 엑셀 주문서를 눈으로 확인
- ERP에서 품목 검색 후 수동 입력
- 건당 약 10분 소요
- 휴먼 에러 발생 가능

**자동화 후 (TO-BE)**:
- 다채널 주문 자동 수집 (엑셀, 문자, 이미지)
- AI 기반 7단계 매칭으로 ERP 품목 자동 연결
- 건당 약 30초 소요 (95% 단축)
- 매칭 정확도 96-97%

---

## 기술 스택

```yaml
Workflow Engine: n8n (Self-hosted, Docker)
AI Integration:
  - OpenAI GPT-4.1-mini: 자연어 → 핵심 식재료명 추출
  - Claude API: 복잡한 매칭 판단
  - Google Vision API: 이미지 OCR
External APIs:
  - Gmail OAuth2: 이메일 주문 자동 수집
  - Popbill 카카오톡 API: 알림톡 발송
  - Google Calendar API: 작업 이력 자동 등록
Database:
  - n8n Data Table: 품목 마스터 캐시
  - PostgreSQL: 자연어 사전, 매칭 이력
Infrastructure: Docker, Nginx Reverse Proxy
```

---

## 워크플로우 상세

### 1. 엑셀 주문 처리 워크플로우

**노드 구성**: 약 15개 노드

**처리 흐름**:
```
Webhook 수신
    ↓
거래처별로 분리 (이용인/직원 구분)
    ↓
자연어 사전 조회 (n8n Data Table)
    ↓
7단계 우선순위 매칭
    ↓
[매칭 실패 시] AI 처리 (GPT-4.1-mini → 핵심 식재료 추출)
    ↓
품목 마스터에서 재매칭
    ↓
데이터 최종 정렬 및 통계 생성
    ↓
Webhook 응답 + Google Calendar 등록
```

### 2. 7단계 우선순위 매칭 로직

```javascript
// 우선순위별 매칭 전략
1순위: 동일 거래처 정확 일치
       → confidence: 1.0
       → 예: "소 국거리" = "소 국거리" (같은 거래처)

2순위: 타 거래처 정확 일치
       → confidence: 0.9
       → 예: "소 국거리" = "소 국거리" (다른 거래처)

3순위: 동일 거래처 부분 포함
       → confidence: 0.8
       → 예: "소 국거리" ⊂ "소 국거리 1kg"

4순위: 타 거래처 부분 포함
       → confidence: 0.7

5순위: 정규화 후 일치
       → confidence: 0.6
       → 공백, 특수문자, 숫자 제거 후 비교

6순위: 유사어 그룹 매칭
       → confidence: 0.5
       → 예: ['소고기', '쇠고기', '한우', '국거리']

7순위: AI 처리 필요
       → 관리자 수동 입력 → 자연어 사전 등록
```

### 3. 유사어 그룹 정의

```javascript
const similarityGroups = [
  ['닭다리살', '닭다리', '닭고기', '치킨', '닭', '닭반각', '닭볶음탕'],
  ['소고기', '쇠고기', '우육', '한우', '소', '국거리'],
  ['돼지고기', '돈육', '삼겹살', '목살', '돈', '돈민찌', '민찌'],
  ['계란', '달걀', '지단', '에그', '란'],
  ['메추리', '메추리알', '깐메추리'],
  ['버섯', '느타리', '팽이버섯', '새송이', '표고', '팽이'],
  ['김치', '배추김치', '포기김치', '맛김치'],
  // ... 28개 그룹
];
```

### 4. AI 핵심 식재료 추출

매칭 실패 시 GPT-4.1-mini로 자연어에서 핵심 키워드 추출:

```
입력: "냉동)깐메추리알1kg"
출력: "메추리알"

입력: "소 국거리"
출력: "소고기"

입력: "메밀전병"
출력: "메밀전병"
```

---

## 자연어 사전 시스템

> 100% 내가 기획하고 개발한 핵심 기능

### 개념
- 관리자가 자연어 → 품목 매칭을 수동으로 지정하면 DB에 저장
- 다음에 동일 자연어 주문 시 즉시 매칭 (학습형 시스템)
- 거래처별로 다른 자연어 사전 관리 가능

### 데이터 구조
```sql
CREATE TABLE itname_dict (
  id SERIAL PRIMARY KEY,
  cl_code VARCHAR(20),      -- 거래처 코드
  ori_itname VARCHAR(100),  -- 원본 자연어 (예: "소 국거리")
  it_code VARCHAR(20),      -- ERP 품목 코드
  it_name VARCHAR(100),     -- ERP 품목명
  use_count INT DEFAULT 1,  -- 사용 횟수
  last_sale DATE,           -- 마지막 매칭일
  created_at TIMESTAMP
);
```

### 효과
- 초기 매칭률 50% → 자연어 사전 적용 후 97%
- 사용할수록 정확도 향상 (자기 학습)
- 거래처별 특성 반영 가능

---

## 캐시 시스템

### 문제
- 매 요청마다 ERP 품목 DB 조회 → 성능 저하
- 품목 마스터: 수만 건

### 해결: n8n Data Table 캐시
```
┌─────────────────────────────────────────┐
│  스케줄 노드 (매일 새벽 3시)              │
│         ↓                               │
│  ERP DB에서 품목 마스터 전체 조회         │
│         ↓                               │
│  n8n Data Table에 저장 (캐시)            │
│         ↓                               │
│  워크플로우 실행 시 캐시에서 조회         │
└─────────────────────────────────────────┘
```

### 효과
- DB 부하 90% 감소
- 응답 속도 개선

---

## 성과 지표

| 지표 | Before | After | 개선율 |
|------|--------|-------|--------|
| 처리 시간 | 10분/건 | 30초/건 | 95% 단축 |
| 매칭 정확도 | 50% | 97% | 47%p 향상 |
| 일일 처리량 | 30건 | 100건+ | 3배+ 증가 |
| DB 조회 부하 | 100% | 10% | 90% 감소 |

---

## 발전 히스토리

### 인턴 기간 (2025.07-08)
- v1: 정확 일치만 → 매칭률 50%
- v2: AI 자연어 변환 추가 → 60%
- v3: 최근 주문 기반 매칭 → 75%

### 정규직 기간 (2025.09~)
- v4: 매칭 이력 DB 저장 → 85%
- v5: n8n 캐시 시스템 → 90%
- v6: 자연어 사전 + 7단계 우선순위 → 97%
- v7: 시나브로G 플랫폼 통합

### 아키텍처 개선
- **인턴 때**: A→B→A 형태의 비효율적 데이터 흐름
- **현재**: 프론트/n8n 역할 명확 분리, 필요한 데이터만 전달
